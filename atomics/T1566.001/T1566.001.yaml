attack_technique: T1566.001
display_name: 'Phishing: Spearphishing Attachment'
atomic_tests:
  - name: Simulate sending a phishing email with a malicious attachment via SMTP
    auto_generated_guid: custom-guid-phishing-attachment
    description: |
      This test simulates sending a phishing email with a malicious attachment using PowerShell.
      WARNING: THIS IS A SIMULATION AND SHOULD ONLY BE RUN IN A CONTROLLED ENVIRONMENT.
    supported_platforms:
      - windows
    input_arguments:
      smtp_server:
        description: Serveur SMTP √† utiliser
        description: SMTP server to use
        type: string
        default: "smtp.gmail.com"
      smtp_port:
        description: Port SMTP
        description: SMTP port
        type: integer
        default: 587  # Port TLS
        default: 587  # TLS Port
      sender_email:
        description: Adresse e-mail r√©elle pour l'authentification SMTP
        description: Real email address for SMTP authentication
        type: string
        default: "chaymaoumayma2003@gmail.com"  # Remplacez par une adresse Gmail valide
        default: "chaymaoumayma2003@gmail.com"  # Replace with a valid Gmail address
      sender_visible_email:
        description: Adresse e-mail visible dans le champ "From"
        description: Email address visible in the "From" field
        type: string
        default: "chaymabouattour1@gmail.com"  # Utilisez un domaine similaire √† celui de l'entreprise cible
        default: "chaymabouattour1@gmail.com"  # Use a domain similar to the target's organization
      recipient_email:
        description: Adresse e-mail du destinataire
        description: Recipient email address
        type: string
        default: "oumaymakabadou2@gmail.com"  # Remplacez par une adresse email r√©elle
        default: "oumaymakabadou2@gmail.com"  # Replace with a real email address
      subject:
        description: Objet personnalis√© de l'e-mail
        description: Customized subject of the email
        type: string
        default: "‚ö†Ô∏è Action requise : Votre compte n√©cessite une mise √† jour"
        default: "‚ö†Ô∏è Urgent: Please review the attached document"
      body:
        description: Corps personnalis√© de l'e-mail
        description: Customized body of the email
        type: string
        default: |
          Bonjour,
          Nous avons remarqu√© une activit√© inhabituelle sur votre compte. Pour prot√©ger vos donn√©es, veuillez t√©l√©charger et consulter le document s√©curis√© ci-joint.
          Merci de votre coop√©ration.
          Cordialement,
          L'√©quipe de s√©curit√©
          Dear User,
          
          We have detected unusual activity on your account. To secure your data, please review the attached document as soon as possible.
          
          Thank you for your cooperation.
          
          Best regards,
          The Security Team
      attachment_path:
        description: Chemin vers la pi√®ce jointe (g√©n√©r√©e par T1027)
        description: Path to the attachment (generated by T1027)
        type: string
        default: "C:\\temp\\CompressedAttachment.zip.txt"  # R√©f√©rence dynamique au fichier g√©n√©r√© par T1027
        default: "C:\\temp\\SecureDocument.xlsm"  # Reference to the file generated by T1027
      app_password:
        description: Mot de passe d'application pour l'authentification SMTP
        description: Application password for SMTP authentication
        type: string
        default: "wbae yozc iyut rykk"  # Mot de passe d'application g√©n√©r√©
        default: "wbae yozc iyut rykk"  # Generated application password
      log_file:
        description: Chemin vers le fichier de journalisation
        description: Path to the log file
        type: string
        default: "C:\\temp\\phishing_logs.txt"
    executor:
      name: powershell
      elevation_required: false
      command: |
        $smtpServer = "#{smtp_server}"
        $smtpPort = "#{smtp_port}"
        $senderEmail = "#{sender_email}"  # Adresse r√©elle pour authentification
        $senderVisibleEmail = "#{sender_visible_email}"  # Adresse visible dans le champ "From"
        $senderEmail = "#{sender_email}"  # Real address for authentication
        $senderVisibleEmail = "#{sender_visible_email}"  # Address visible in the "From" field
        $recipientEmail = "#{recipient_email}"
        $subject = "#{subject}"
        $body = "#{body}"
        $attachmentPath = "#{attachment_path}"
        $securePassword = ConvertTo-SecureString "#{app_password}" -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential($senderEmail, $securePassword)
        $headers = @{
            "X-Priority" = "1"
            "X-MSMail-Priority" = "High"
            "Importance" = "High"
        }
        Write-Host "üìß Envoi d'un email r√©el via SMTP..."
        Write-Host "üìß Sending a real email via SMTP..."
        try {
            Send-MailMessage -SmtpServer $smtpServer -Port $smtpPort -UseSsl `
                -From $senderVisibleEmail -To $recipientEmail `
                -Subject $subject -BodyAsHtml $body `
                -Attachments $attachmentPath -Credential $credential -Headers $headers -ErrorAction Stop
            Write-Host "‚úÖ Email envoy√© avec succ√®s."
            $logEntry = "Email envoy√© √† $recipientEmail avec succ√®s le $(Get-Date)"
            Write-Host "‚úÖ Email sent successfully."
            $logEntry = "Email sent to $recipientEmail successfully at $(Get-Date)"
            Add-Content -Path "#{log_file}" -Value $logEntry
        } catch {
            Write-Host "‚ùå Erreur lors de l'envoi de l'email : $_"
            Write-Host "‚ùå Error sending email: $_"
            exit 1
        }
